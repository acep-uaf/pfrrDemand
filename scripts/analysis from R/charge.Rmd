---
title: "Demand charge analysis"
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F ,message = F, warning = F, fig.height= 4, fig.width= 10)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(forcats)
library(pander)
library(stringr)
library(kableExtra)
```

# Total aggregated power (kW) for demand charge based on month

The aggregated total power (kW) on a monthly basis will show the trend of peak demand power over the past 3 years. This will help to analyze the effect of a virtual meter by comparing the separate billing of the four meters and the aggregated billing of the virtual meter. 

Using ARIMA, the trend of aggregated meter powers were forecasted based on month, which is the billing cycle for demand charge. The power trends were plotted with maximum value of the peak power during the month because the peak power decides the billing cost.


It turns out having a virtual meter by aggregating all the power consumptions of all four meters, reduces the peak demand as shown in the Figure below. Every month has less peak demand by a virtual meter compared to summing up all the peak demand of the individual meters during a billing cycle. 


## Montly maximum peak power(kW) trend

```{r}
data <- read_csv(file = "df.csv") %>% 
  mutate(time = as.POSIXct(time, format="%m/%d/%Y %H:%M"))
  
# glimpse(data)
# View(data)

data["year"] <- year(data[["time"]])
data["month"] <- month(data[["time"]])
                                                                
data <- data %>% 
  group_by(year, month) %>% 
  summarise(PQ_e = sum(PQ,na.rm=T)/60, Wat1_e = sum(Wat1,na.rm=T)/60, Wat2_e = sum(Wat2,na.rm=T)/60, 
            Wat3_e = sum(Wat3,na.rm=T)/60, Tot_kwh = PQ_e+Wat1_e+Wat2_e+Wat3_e) %>% 
  mutate(month_ = sprintf("%02d", month),
         time = ymd(str_c(year, month_,"01"))) %>% 
  select(time, PQ_e, Wat1_e, Wat2_e, Wat3_e, Tot_kwh)

pwr <- data[c(-1)]


data <- read_csv(file = "15m.csv") %>% 
  drop_na() %>% 
  mutate(total_v = PQ+Wat1+Wat2+Wat3)

data["year"] <- year(data[["time"]])
data["month"] <- month(data[["time"]])
data["day"] <- day(data[["time"]])
data["hour"] <- hour(data[["time"]])
data["minute"] <- minute(data[["time"]])

data <- data %>%
  group_by(year, month) %>%
  summarise(PQ = max(PQ,na.rm=T), Wat1 = max(Wat1,na.rm=T), Wat2 = max(Wat2,na.rm=T), 
            Wat3 = max(Wat3,na.rm=T), total_v = max(total_v, na.rm=T), Tot_kw = PQ+Wat1+Wat2+Wat3) %>% 
  mutate(month_ = sprintf("%02d", month),
         time = ymd(str_c(year, month_, "01"))) %>% 
  select(time, PQ, Wat1, Wat2, Wat3, total_v, Tot_kw)

dmd <- data[c(-1)]

data <- dmd %>% inner_join(pwr, by="time")

  
data %>% 
  ggplot(aes(x = time, y = total_v, color = "virtual meter")) +
  geom_line() +
  geom_line(aes(y = Tot_kw, color = "aggregated 4 meters"))+
  scale_color_manual(name = "Peak power (kW):", values = c("virtual meter" = "red",
                                                           "aggregated 4 meters" = "blue"))+
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("Montly peak demand (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 

```


## Density of maximum peak power (kW)

The figure below shows by having a virtual meter, the peak demand density becomes lower. It shows the distribution of peak power or probability that what value of peak power (kW) is highly expected for the cases of a virtual meter scenario and the total of the individual 4 meters. It shows that having a virtual meter reduced the probability of higher peak power across months. 

```{r}

d <- density(data$total_v, adjust = 1, na.rm = TRUE)
d_kw <- density(data$Tot_kw, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for peak power (kW)", xlab='Power (kW)', col="red")
lines(d_kw, col="blue")
legend('topleft', legend=c("virtual meter", "aggregated 4 meters"),
       col=c("red", "blue"), lty=1)
```

## Prediction performance for the last 3 months

There are slightly difference between monthly peak demand forecasts of a virtual meter and aggregated four meters. 

```{r}

library(forecast)
fit <- auto.arima(data$total_v[1:13], max.p = 20, max.q = 20, max.d = 2, ic = "aic")
fit_kw <- auto.arima(data$Tot_kw[1:13], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit), main = "Vitual meter forecast", col="blue",
     xlab="Ordinal month since Nov. 2017", ylab="Power (kW)")
axis(side=1, at=c(0:23))
lines(data$total_v, col="brown")
abline(v=c(14,16), col='red')
text(15, 200, "Prediction vs. Real")
```

```{r}

plot(forecast(fit_kw), main="Forecast for aggregated 4 meters", col="blue", 
     xlab="Ordinal month since Nov. 2017", ylab="Power (kW)")
lines(data$Tot_kw, col="brown")
axis(side=1, at=c(0:23))
abline(v=c(14,16), col='red')
text(15, 200, "Prediction vs. Real")

```


# Benefit-cost analysis of involving a virtual meter

A virtual meter could save money by aggregating all the meters resulting in a payment once during a billing cycle as opposed to several billed payments, in this case four times. On the other hand, vitual meter may lead to higher rate per unit kW for the demand charge. For example, the utility has charged `Poker flat` \$14.29 per kW for GS-2 service while GS-3 would involve \$22.89 per kW. So it is necessary to perform a benefit-cost analysis to find if saving could happen by implementing a virtual meter. 

```{r}

ad_G2 = 30
kwh_G2 = 0.06256+0.09207
kw_G2 = 14.29

ad_G3 = 295
kwh_G3 = 0.0294+0.09207               
kw_G3 = 22.86

chrg <- data %>% 
  mutate(charge_G2= Tot_kw*kw_G2 + Tot_kwh*kwh_G2 + ad_G2*4,
         charge_G3= total_v*kw_G3 + Tot_kwh*kwh_G3 + ad_G3,
         saving = charge_G2 - charge_G3)
```

On the other hand, GS-3 service has higher utility charge of \$0.0294 per kWh while GS-2 has \$0.06256 per kWh. The monthly power consumption for each meter and the total are shown in the figure below. Note that the energy consumption value is for each month in order since November 2017 to April 2019. 

```{r}

plot(chrg$time, chrg$Tot_kwh/1000, main="Monthly energy consumption (MWh)", type="l", 
     xlab='Month (2017 - 2019)', col="black", ylim=c(0,400), ylab="Power consumption (MWh)", xaxt="n")
lines(chrg$time,chrg$Wat1_e/1000, col="blue")
lines(chrg$time,chrg$PQ_e/1000, col="red")
lines(chrg$time,chrg$Wat3_e/1000, col="brown")
lines(chrg$time,chrg$Wat2_e/1000, col="gold")
axis.Date(side=1, at=chrg$time, labels=format(chrg$time, "%b"))
legend('topright', legend=c("Total", "Wat1","PQ","Wat3","Wat2"),
       col=c("black","blue","red","brown","gold"), lty=1)


```

Adding customer charge and fuel & purchased power charge, which are fixed during a month, the total estimated electricity costs for the both cases (1) payments for the individual 4 meters, and (2) a payment for the virtual meter, were caculated. 

```{r}
read_csv(file = "Rate.csv") %>%
  kable(caption = "Rate schedule") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = T,
                position = "center") 
  

```


It turns out aggregating all the meters by a virtual meter ends up with paying less with less peak power during a billing cycle as opposed to the aggregation of the peak power of the individual four meters. Note that a specific month has a negative saving meaning that the virtual meter option loses money. It is interesting to see that it would be more beneficial to have a virtual meter when higher energy consumption (kWh) is expected leading to more profitable option. The highest saving would be \$`r round(max(chrg$saving),1)` on `r str_replace(chrg[[which(chrg$saving == max(chrg$saving)), 1]], "-01", "")` and the lowest, \$`r round(min(chrg$saving),2)` on `r str_replace(chrg[[which(chrg$saving == min(chrg$saving)), 1]], "-01", "")`, where the negative saving is due to the lower energy consumption on the month resulting from data missing. 

```{r}


chrg %>% 
  ggplot(aes(x = time, y = charge_G3/ 1000, color="A virtual meter")) +
  geom_line() +
  geom_line(aes(y = charge_G2/ 1000, color="4 meters")) +
  geom_line(aes(y = saving/ 1000, color="Savings")) +
  xlab("Monthly billing cycle (2017 - 2019)") + 
  ylab("Monthly charge ($1K)") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_color_manual(name = "Elec. Cost:", values = c("A virtual meter" = "red","4 meters" = "blue",
                                                      "Savings" = "Gold"))+
  ggtitle("Electricity cost ($1K)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 

```

The saving distribution is as below showing the most savings would occur between \$4,000 to \$7,000 a month. 

```{r}
d <- density(chrg$saving/ 1000, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for savings ($1K) ", xlab='Savings ($1K)', col="red")
abline(v=mean(chrg$saving/1000), col="blue")
legend('topleft', legend=c("Savings", "Average savings"),
       col=c("red", "blue"), lty=1)
```



The estimated average montly saving would be \$`r round(sum(chrg$saving)/16, 2)` due to its skewness to left. So the conclusion is having a vurtaul meter is viable and saving money by reducing the billing. 

* Note that the last month in the data, which is April of 2019, has only 10 days data available so the values are relatively lower than other months. 

* There are missing months such as November and December of 2018, and missing days specially in September, 2018 so the total energy consumption and peak power comparatively lower than other months. 

* Nontheless, for the purpose of comparison of the both cases (a virtual meter, and 4 meters), this won't be an issue as it applies the same to the both cases and still make the cases comparable.



