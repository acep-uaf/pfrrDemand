---
title: "Demand charge analysis"
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F ,message = F, warning = F, fig.height= 4, fig.width= 10)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(forcats)
library(pander)
library(stringr)
library(broom)
library(kableExtra)
```


<!-- data <- read_csv(file = "dat.csv") -->
<!-- View(data) -->
<!-- glimpse(data) -->


<!-- cnt <- data %>%  -->
<!--   group_by(year, month) %>%  -->
<!--   summarise(count = n()) -->

<!-- data <- data %>%  -->
<!--   mutate(index = append(seq(cnt[[1,3]]), c(seq(cnt[[2,3]]), seq(cnt[[3,3]]),seq(cnt[[4,3]]), -->
<!--                         seq(cnt[[5,3]]), seq(cnt[[6,3]]), seq(cnt[[7,3]]), seq(cnt[[8,3]]), -->
<!--                         seq(cnt[[9,3]]), seq(cnt[[10,3]]))), -->
<!--          year = factor(year), -->
<!--          month = factor(month), -->
<!--          PQ = PQ/ 1000, -->
<!--          Total = PQ + Wat1 + Wat2 + Wat3) -->
  
<!-- #             -->
<!-- # de_plot <- function(y){ -->
<!-- #   y = y -->
<!-- #   a1 = list() -->
<!-- #   a2 = list() -->
<!-- #   for(i in length(y)){ -->
<!-- #     a1[[i]] <-  -->
<!-- #       ggplot(data = data, aes(x = index, y = !!sym(y[i]), color = year)) + -->
<!-- #       geom_line() + -->
<!-- #       xlab("Days in a month") +  -->
<!-- #       ylab("Power (kW)") + -->
<!-- #       ggtitle("15 mins demand charge power (kW)") + -->
<!-- #       theme_bw() +  -->
<!-- #       facet_wrap(~ month) + -->
<!-- #       theme_minimal(base_size = 14)  -->
<!-- #      -->
<!-- #     a2[[i]] <-  -->
<!-- #       ggplot(data = data, aes(x = index, y = !!sym(y[i]), color = month)) + -->
<!-- #       geom_line(size = 1) + -->
<!-- #       xlab("Days in a month") +  -->
<!-- #       ylab("Power (kW)") + -->
<!-- #       ggtitle("15 mins demand charge power (kW)") + -->
<!-- #       theme_bw() +  -->
<!-- #       facet_wrap(~ year) + -->
<!-- #       theme_minimal(base_size = 14)  -->
<!-- #   } -->
<!-- #   return(a1) -->
<!-- # } -->



# Power (kW) for demand charge correlation

These 4 meters have power (kW) correlated each other for the past 3 years. The correlations are various depending upon the comparisons. In general, power in `PQ` meter is mostly correlated with power in `Wat3`. This founding is interesting as the more correlated, the more dependency resulting in less effective to address load reduction of having a virtual meter, are expected. 

```{r}

data <- read_csv(file = "15m.csv")

library('quantmod')
data <- xts::xts(data[,-1], order.by = data$time)

PQ = as.vector(data[,"PQ"])
Wat1 = as.vector(data[,"Wat1"])
Wat2 = as.vector(data[,"Wat2"])
Wat3 = as.vector(data[,"Wat3"])

library(corrplot)
rates <- data.frame(PQ, Wat1, Wat2, Wat3)
corrplot.mixed(cor(rates, use="pairwise.complete.obs"),upper="ellipse")
```

# Past 3 years power trends of each meter (Nov. 2017 to Apr. 2019)

Variances of power (kW) for each meter, verify the correlations found in the previous correlation plot.

```{r}

plot(data, multi.panel=4, grid.ticks.lwd=0)
```


A regression model for power of `PQ` shows `Wat3` is the most significant followed by `Wat2` resulting in 0.72 in adjusted R-squared. They are higly correlated. 

```{r}

fit <- lm(PQ ~ Wat1+Wat2+Wat3)
fit %>% tidy() %>% 
  mutate_if(is.numeric, round, digits=2) %>%
  kable(caption = "PQ power (kW) regression in Wat1, Wat2 and Wat3") %>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = T,
                position = "center") 

```



# Forecast based on month

Using ARIMA, power trends of each meter were forecasted based on month, which is the billing cycle for demand charge. The power trends were plotted with maximum value of the peack power during the month because the peak power decides the billing cost. 

## PQ

It was expected that power for PQ would be around 125 kW for the last 3 months and the real values for these months were 114, 107, and 131 kW respectively. 


### Montly maximum peak power(kW) trend

```{r}

data <- read_csv(file = "month.csv")

data %>% 
  ggplot(aes(x = time, y = PQ)) +
  geom_line(color="blue") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("PQ demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```

### Density of maximum peak power (kW)

The density plot shows the distribution of the monthly peak power for each meter. For `PQ`, peak power around 125 kW is mostly prevalent, which means there is more probability that `PQ` peak power would be around 125 kW. 

```{r}

d <- density(data$PQ, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for PQ power (kW)", xlab='Power (kW)', col="red") # simple plot
```


### Prediction performance for the last 3 months

ARIMA predicted the peak power for the last 3 months, which is February, March, and April given the previous peak power data from November, 2017 to January, 2019. Since there are 2 months missing (November and December of 2018), the months used for the prediction were 13 months. Given the historical data of 13 months, the model predicts the coming 3 months and it is quite accurate as around 125 kW compared to the real values for these months, 114, 107, and 131 kW respectively. 



```{r}

dat <- data.frame(data) %>% 
  drop_na()

library(forecast)
fit <- auto.arima(dat$PQ[1:13], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit), col="blue", xlab="Ordinal month since Nov. 2017", ylab="Power (kW)")
lines(dat$PQ, col="brown")
axis(side=1, at=c(0:23))
abline(v=c(14,16), col='red')
text(15, -50, "Prediction vs. Real")

```


## Wat1

It was expected that power for Wat1 would be around 372 kW for the last 3 months and the real values for these months were 385, 377, and 370 kW respectively. 

### Montly maximum peak power(kW) trend

```{r}

data %>% 
  ggplot(aes(x = time, y = Wat1)) +
  geom_line(color="blue") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("Wat1 demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$Wat1, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for Wat1 power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 3 months

```{r}

fit <- auto.arima(dat$Wat1[1:13], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit), col="blue", xlab="Ordinal month since Nov. 2017", ylab="Power (kW)")
lines(dat$Wat1, col="brown")
abline(v=c(14,16), col='red')
axis(side=1, at=c(0:23))
text(15, 325, "Prediction vs. Real")

```

## Wat2

It was expected that power for Wat2 would be around 18 kW for the last 3 months and the real values for these months were 20, 19, and 17 kW respectively. 

### Montly maximum peak power(kW) trend

```{r}

data %>% 
  ggplot(aes(x = time, y = Wat2)) +
  geom_line(color="blue") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("Wat2 demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$Wat2, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for Wat2 power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 3 months

```{r}

fit <- auto.arima(dat$Wat2[1:13], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit), col="blue",xlab="Ordinal month since Nov. 2017", ylab="Power (kW)")
lines(dat$Wat2, col="brown")
axis(side=1, at=c(0:23))
abline(v=c(14,16), col='red')
text(15, -40, "Prediction vs. Real")

```

## Wat3

It was expected that power for Wat3 would be around 68 kW for the last 3 months and the real values for these months were 89, 52, and 85 kW respectively. 

### Montly maximum peak power(kW) trend

```{r}

data %>% 
  ggplot(aes(x = time, y = Wat3)) +
  geom_line(color="blue") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") +  
  ylab("Power (kW)") +
  ggtitle("Wat3 demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$Wat3, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for Wat3 power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 3 months

```{r}

fit <- auto.arima(dat$Wat3[1:13], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit), col="blue",xlab="Ordinal month since Nov. 2017", ylab="Power (kW)")
lines(dat$Wat3, col="brown")
axis(side=1, at=c(0:23))
abline(v=c(14,16), col='red')
text(15, 0, "Prediction vs. Real")

```



# Forecast based on day

For the comparison, forecastes based on day, were also plotted. The range between the upper and lower bound of forecast shows narrower than the one based on month. 

## PQ

### Daily maximum peak power(kW) trend

```{r}
data <- read_csv(file = "day.csv")

data %>% 
  ggplot(aes(x = time, y = PQ)) +
  geom_line(color="blue") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("PQ demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$PQ, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for PQ power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 10 days

There are total 413 days previously available since November 2017 till April 2019. Given the 404 days, rest of 10 days were predicted from 405th day to 413th day as below in the figure. 

```{r}

dat <- data.frame(data) %>% 
  drop_na()

fit <- auto.arima(dat$PQ[1:404], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit),xlab="Ordinal day since Nov.1, 2017", ylab="Power (kW)")
axis(side=1, at=c(seq(0,416, by=25)))
lines(dat$PQ, col="brown")
abline(v=c(404,413), col='red')
text(350, 150, "Prediction vs. Real")

```



## Wat1


### Daily maximum peak power(kW) trend

```{r}

data %>% 
  ggplot(aes(x = time, y = Wat1)) +
  geom_line(color="blue") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("Wat1 demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$Wat1, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for Wat1 power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 10 days

```{r}

fit <- auto.arima(dat$Wat1[1:404], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit),xlab="Ordinal day since Nov.1, 2017", ylab="Power (kW)")
axis(side=1, at=c(seq(0,416, by=25)))
lines(dat$Wat1, col='brown')
abline(v=c(404,413), col='red')
text(350, 220, "Prediction vs. Real")

```


## Wat2


### Daily maximum peak power(kW) trend

```{r}

data %>% 
  ggplot(aes(x = time, y = Wat2)) +
  geom_line(color="blue") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("Wat2 demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$Wat2, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for Wat2 power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 10 days

```{r}

fit <- auto.arima(dat$Wat2[1:404], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit),xlab="Ordinal day since Nov.1, 2017", ylab="Power (kW)")
axis(side=1, at=c(seq(0,416, by=25)))
lines(dat$Wat2, col='brown')
abline(v=c(404,413), col='red')
text(350, 7, "Prediction vs. Real")

```

## Wat3


### Daily maximum peak power(kW) trend

```{r}

data %>% 
  ggplot(aes(x = time, y = Wat3)) +
  geom_line(color="blue") +  
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  xlab("Month (2017 - 2019)") + 
  ylab("Power (kW)") +
  ggtitle("Wat3 demand charge power (kW)") +
  theme_bw() + 
  theme_minimal(base_size = 14) 
```


### Density of maximum peak power (kW)

```{r}

d <- density(data$Wat3, adjust = 1, na.rm = TRUE)
plot(d, main="KDE for Wat3 power (kW)", xlab='Power (kW)', col='red') # simple plot
```

### Prediction performance for the last 10 days

```{r}

fit <- auto.arima(dat$Wat3[1:404], max.p = 20, max.q = 20, max.d = 2, ic = "aic")

plot(forecast(fit),xlab="Ordinal day since Nov.1, 2017", ylab="Power (kW)")
axis(side=1, at=c(seq(0,416, by=25)))
lines(dat$Wat3, col='brown')
abline(v=c(404,413), col='red')
text(350, 20, "Prediction vs. Real")

```
